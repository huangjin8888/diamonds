<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta name="renderer" content="webkit" />

		<title>首页</title>

		<meta name="keywords" content="Galaxy Racing" />
		<meta name="description" content="Galaxy Racing" />

		<!--[if lt IE 9]>
			<meta http-equiv="refresh" content="0;ie.html" />
		<![endif]-->

		<link rel="shortcut icon" href="favicon.ico" />
		<link href="css/bootstrap.min.css?v=3.3.7" rel="stylesheet" />
		<link href="css/font-awesome.min.css?v=4.4.0" rel="stylesheet" />
		<link href="css/animate.css" rel="stylesheet" />
		<link href="css/style.css?v=4.1.0" rel="stylesheet" />
		<link href="css/jquery.contextMenu.min.css" rel="stylesheet"/>
   		<link rel="stylesheet" href="css/style.css">
	    <link href="css/plugins/sweetalert/sweetalert.css" rel="stylesheet">
	    <script src="js/plugins/sweetalert/sweetalert.min.js"></script>
		<style>
			.px-4 {
				padding-left: 1rem;
				padding-right: 1rem;
			}
			.py-2 {
				padding-top: 0.5rem;
				padding-bottom: 0.5rem;
			}
			.bg-opacity-50 {
				--tw-bg-opacity: 0.5;
			}
			.bg-gray-900 {
				--tw-bg-opacity: 1;
				background-color: rgba(17,24,39,var(--tw-bg-opacity));
			}
			.rounded-md {
				border-radius: 0.375rem;
			}
			.flex-col {
				flex-direction: column;
			}
			.flex {
				display: flex;
			}
			.mx-2 {
				margin-left: 0.5rem;
				margin-right: 0.5rem;
			}
			.text-white {
				--tw-text-opacity: 1;
				color: rgba(255,255,255,var(--tw-text-opacity));
			}
			.text-sm {
				font-size: .875rem;
				line-height: 1.25rem;
			}
			.text-indigo-500 {
				--tw-text-opacity: 1;
				color: rgba(99,102,241,var(--tw-text-opacity));
			}
			.font-bold {
				font-weight: 700;
			}
		</style>
	</head>

	<body class="fixed-sidebar full-height-layout gray-bg" style="overflow: hidden;">
		<div id="wrapper">
			<!--左侧导航开始-->
			<nav class="navbar-default navbar-static-side" role="navigation">
				<div class="nav-close"><i class="fa fa-times-circle"></i></div>
				<div class="sidebar-collapse">
					<ul class="nav" id="side-menu">
						<li class="nav-header">
							<div class="dropdown profile-element">
								<span>
									<img alt="image" src="img/logo.png">
								</span>
							</div>
							<div class="logo-element">G</div>
						</li>
						<li>
							<a href="#" style="pointer-events: none;">
								<span class="nav-label flex flex-col px-4 py-2 mx-2 rounded-md bg-gray-900 bg-opacity-50">
									<div class="text-l text-indigo-500 font-bold">
										<font style="vertical-align: inherit;">
											<font style="vertical-align: inherit;">玩游戏</font>
										</font>
									</div>
								</span>
							</a>
							<ul class="nav nav-second-level collapse in">
								<li>
									<a class="J_menuItem" href="list_worker.html">
										<i class="fa fa-users"></i>
										工人
										<span class="label label-success pull-right" id="workerCount">-</span>
									</a>
								</li>
								<li>
									<a class="J_menuItem" href="list_hoe.html">
										<i class="fa fa-wrench"></i>
										锄头
										<span class="label label-success pull-right" id="hoeCount">-</span>
									</a>
								</li>
								<li>
									<a class="J_menuItem" href="game.html">
										<i class="fa fa-dashboard"></i>
										挖矿
									</a>
								</li>
							</ul>
						</li>
						<li>
							<a href="#" style="pointer-events: none;">
								<span class="nav-label flex flex-col px-4 py-2 mx-2 rounded-md bg-gray-900 bg-opacity-50">
									<div class="text-l text-indigo-500 font-bold">
										<font style="vertical-align: inherit;">
											<font style="vertical-align: inherit;">市场</font>
										</font>
									</div>
								</span>
							</a>
							<ul class="nav nav-second-level collapse in">
								<li>
									<a class="J_menuItem" href="market_worker.html">
										<i class="fa fa-shopping-cart"></i>
										工人
									</a>
								</li>
								<li>
									<a class="J_menuItem" href="market_hoe.html">
										<i class="fa fa-shopping-cart"></i>
										锄头
									</a>
								</li>
							</ul>
						</li>
						<li>
							<a href="#" style="pointer-events: none;">
								<span class="nav-label flex flex-col px-4 py-2 mx-2 rounded-md bg-gray-900 bg-opacity-50">
									<div class="text-l text-indigo-500 font-bold">
										<font style="vertical-align: inherit;">
											<font style="vertical-align: inherit;">兑换</font>
										</font>
									</div>
								</span>
							</a>
							<ul class="nav nav-second-level collapse in">
								<li>
									<a class="J_menuItem" href="list_box.html">
										<i class="fa fa-shopping-cart"></i>
										盲盒
									</a>
								</li>
								<li>
									<a class="J_menuItem" href="wallet.html">
										<i class="fa fa-shopping-cart"></i>
										代币
									</a>
								</li>
							</ul>
						</li>
					</ul>
				</div>
			</nav>
			<!--左侧导航结束-->
			<!--右侧部分开始-->
			<div id="page-wrapper" class="gray-bg dashbard-1">
				<div class="row border-bottom">
					<nav class="navbar navbar-static-top" role="navigation" style="margin-bottom: 0;">
						<ul class="nav navbar-top-links navbar-left">
							<li class="dropdown">	
								<div style="font-size:18px;color:#ffffff;padding: 20px 10px;min-height: 50px;">
									欢迎
									<i class="fa fa-credit-card" style="margin-right: 6px;"></i><span id="account">加载中...</span>
								</div>
							</li>
						</ul>
						<ul class="nav navbar-top-links navbar-right">
							<li class="dropdown">	
								<div style="font-size:18px;color:#ffffff;padding: 20px 10px;min-height: 50px;">
									<a class="J_menuItem" href="user_wallet.html">
										<div class="label label-warning" style="font-size:18px" id="galaxy_balance">加载中...</div>
									</a>
									<i class="fa fa-diamond" style="margin-left: 6px;"></i><b>diamonds</b>
									
								</div>
							</li>
						</ul>
					</nav>
				</div>
				
				<div class="row J_mainContent" id="content-main">
					<iframe class="J_iframe" name="iframe0" width="100%" height="100%" src="list_worker.html" frameborder="0" data-id="index_v1.html" seamless></iframe>
					
				</div>
			</div>
			<!--右侧边栏结束-->
		</div>
		<!-- 全局js -->
		<script src="js/jquery.min.js?v=2.1.4"></script>
		<script src="js/bootstrap.min.js?v=3.3.7"></script>
		<script src="js/plugins/metisMenu/jquery.metisMenu.js"></script>
		<script src="js/plugins/slimscroll/jquery.slimscroll.min.js"></script>
		<script src="js/plugins/contextMenu/jquery.contextMenu.min.js"></script>

		<!-- 自定义js -->
		<script src="js/hplus.js?v=4.1.0"></script>
		<script type="text/javascript" src="js/contabs.js"></script>

		<script type="text/javascript" src="js/web3.min.js"> </script>
		<script type="text/javascript" src="abi/abi.js"> </script>
		<script type="text/javascript">
			loadData(function(){
				var account="";
				if (typeof window.ethereum !== 'undefined') {
					var ethereum = window.ethereum
					//禁止自动刷新，metamask要求写的
					ethereum.autoRefreshOnNetworkChange = false
					try {
						//第一次链接Metamask
						var accounts = ethereum.enable()
						provider = new Web3(ethereum);
						var contract_diamonds=new provider.eth.Contract(contracts.diamonds.abi,contracts.diamonds.address);
						var contract_worker=new provider.eth.Contract(contracts.worker.abi,contracts.worker.address);
						var contract_hoe=new provider.eth.Contract(contracts.hoe.abi,contracts.hoe.address);
						provider.eth.getAccounts(function (error, result) {
							if (!error){
								console.log(result)//授权成功后result能正常获取到账号了
								provider.eth.getBalance(result[0]).then(console.log);
								account=result[0];
								//todo 初始化需要调用的合约：查询自己赛车，车手，和车队数量，galaxy余额，solar余额，赛车列表
								initIndex();
								$("#account").html(account);
							}
						});
						ethereum.on('accountsChanged', function (accounts) {
							initIndex();
						})
						ethereum.on('networkChanged', function (networkVersion) {
							console.log("networkChanged:" + networkVersion)
						})
						function initIndex(){
							//查diamonds余额
							contract_diamonds.methods.balanceOf(account).call({from:account},function(error,result){
								$("#galaxy_balance").html(result/10**18);
							});
							contract_worker.methods.balanceOf(account).call({from:account},function(error,result){
								$("#workerCount").html(result);
							});
							contract_hoe.methods.balanceOf(account).call({from:account},function(error,result){
								$("#hoeCount").html(result);
							});
						}
					} catch (e) {
						swal({
						    title: "错误:"+e,
						    type: "error",
						    confirmButtonText:"好的"
						});
					}
				} else {
					swal({
					    title: "没有安装metamask",
					    type: "error",
					    confirmButtonText:"好的"
					});
				}
			});
		</script>
	</body>
</html>
